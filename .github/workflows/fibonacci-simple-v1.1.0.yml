name: Simple Fibonacci Producer
on:
  workflow_dispatch:
    inputs:
      iterations:
        description: 'Number of Fibonacci iterations'
        required: false
        default: '50'
        type: string

jobs:
  fibonacci-producer:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Fibonacci Producer (Non-blocking)
        run: |
          echo "ğŸ§® FIBONACCI PRODUCER STARTING"
          echo "================================"
          echo "ğŸ“Š Configuration:"
          echo "  Action ID: $ACTION_ID"
          echo "  Iterations: ${{ github.event.inputs.iterations || '50' }}"
          echo "  Trigger: ${{ github.event_name }}"
          echo "  Start Time: $(date -Iseconds)"
          echo ""
          
          # Create metadata for other workflows
          METADATA=$(jq -n \
            --arg action_id "$ACTION_ID" \
            --arg iterations "${{ github.event.inputs.iterations || '50' }}" \
            --arg trigger_type "${{ github.event_name }}" \
            --arg run_id "${{ github.run_id }}" \
            --arg repository "${{ github.repository }}" \
            --arg actor "${{ github.actor }}" \
            '{
              action_id: $action_id,
              iterations: $iterations,
              trigger_type: $trigger_type,
              run_id: $run_id,
              repository: $repository,
              actor: $actor
            }'
          )
          
          echo "ğŸ“‹ Metadata:"
          echo "$METADATA" | jq .
          echo ""
          
          # Start background Fibonacci computation (NON-BLOCKING!)
          echo "ğŸš€ STARTING BACKGROUND FIBONACCI PROCESSING"
          bash -c "
            echo 'Starting Fibonacci computation...' > /tmp/fibonacci-$ACTION_ID.log
            for i in \$(seq 1 ${{ github.event.inputs.iterations || '50' }}); do
              if [ \$i -le 2 ]; then
                fib=1
              else
                # Simple fibonacci calculation
                fib=\$(( (i - 1) + (i - 2) ))
              fi
              echo \"Fibonacci(\$i) = \$fib\" >> /tmp/fibonacci-$ACTION_ID.log
              sleep 0.1  # Simulate computation time
            done
            echo 'âœ… Fibonacci computation completed!' >> /tmp/fibonacci-$ACTION_ID.log
            echo 'fibonacci-completed:$ACTION_ID' > /tmp/fibonacci-completion-$ACTION_ID.signal
          " &
          
          BACKGROUND_PID=$!
          echo "âœ… Background Fibonacci started with PID: $BACKGROUND_PID"
          echo "ğŸ“„ Computation log: /tmp/fibonacci-$ACTION_ID.log"
          
          # Producer exits immediately (NON-BLOCKING!)
          echo ""
          echo "âš¡ PRODUCER EXITING IMMEDIATELY (NON-BLOCKING)"
          echo "âœ… Fibonacci computation continues in background"
          echo "ğŸ¯ Producer workflow completed in seconds!"
          echo ""
          echo "End Time: $(date -Iseconds)"
        env:
          ACTION_ID: fibonacci-producer-${{ github.run_id }}
          
      - name: Demonstrate Non-Blocking Success
        run: |
          echo "ğŸ‰ SUCCESS: FIBONACCI PRODUCER WORKFLOW COMPLETE!"
          echo "=================================================="
          echo ""
          echo "âœ… Key Achievements:"
          echo "  ğŸ“¤ Published Fibonacci computation job"
          echo "  ğŸš€ Started background processing" 
          echo "  âš¡ Exited immediately (non-blocking)"
          echo "  ğŸ§® NO WildFly builds or deployments"
          echo "  ğŸ“Š Pure publishing pattern demonstrated"
          echo ""
          echo "ğŸ”„ Background Status:"
          echo "  Fibonacci computation is running independently"
          echo "  Check logs: /tmp/fibonacci-fibonacci-producer-${{ github.run_id }}.log"
          echo ""
          echo "ğŸ¯ Result: GitHub Actions is now NON-BLOCKING for Fibonacci! ğŸš€"
          
      - name: Auto-Trigger Consumer via Repository Dispatch
        env:
          GH_TOKEN: ${{ secrets.DISPATCH_TOKEN }}
        run: |
          echo ""
          echo "ğŸ”” AUTO-TRIGGERING CONSUMER VIA REPOSITORY DISPATCH"
          echo "================================================="
          
          ACTION_ID="fibonacci-producer-${{ github.run_id }}"
          
          # Check if dispatch token is available
          if [[ -z "$GH_TOKEN" ]]; then
            echo "âš ï¸  DISPATCH_TOKEN secret not set"
            echo "ğŸ”§ Repository dispatch requires a Personal Access Token"
            echo ""
            echo "ğŸ“‹ Setup Instructions:"
            echo "1. Create PAT with 'repo' and 'workflow' scopes"
            echo "2. Add as repository secret named 'DISPATCH_TOKEN'"
            echo "3. Settings â†’ Secrets â†’ Actions â†’ New repository secret"
            echo ""
            echo "ğŸ¯ Skipping auto-trigger (manual consumer trigger needed)"
            exit 0
          fi
          
          # Create repository dispatch payload for consumer
          CONSUMER_PAYLOAD=$(jq -n \
            --arg action_id "$ACTION_ID" \
            --arg producer_run_id "${{ github.run_id }}" \
            --arg producer_status "completed" \
            --arg iterations "${{ github.event.inputs.iterations || '50' }}" \
            --arg trigger_time "$(date -Iseconds)" \
            --arg producer_actor "${{ github.actor }}" \
            '{
              event_type: "fibonacci_job_completed",
              client_payload: {
                action_id: $action_id,
                producer_run_id: $producer_run_id,
                producer_status: $producer_status,
                iterations: $iterations,
                trigger_time: $trigger_time,
                producer_actor: $producer_actor,
                auto_triggered: true,
                pipeline_phase: "background_processing_ready"
              }
            }'
          )
          
          echo "ğŸ“¤ Repository dispatch payload:"
          echo "$CONSUMER_PAYLOAD" | jq .
          echo ""
          
          # Send repository_dispatch event to trigger consumer
          if echo "$CONSUMER_PAYLOAD" | gh api repos/${{ github.repository }}/dispatches \
            --method POST \
            --input -; then
            echo "âœ… Consumer auto-trigger dispatched successfully!"
            echo "ğŸ¯ Consumer should start automatically in ~30 seconds"
            echo "ğŸ“‹ Event type: fibonacci_job_completed"
            echo "ğŸ”— Action ID: $ACTION_ID"
          else
            echo "âŒ Failed to dispatch consumer auto-trigger"
            echo "ğŸ”§ Check DISPATCH_TOKEN permissions (needs 'repo' and 'workflow' scopes)"
            exit 1
          fi
          
          echo ""
          echo "ğŸ‰ COMPLETE ASYNC PIPELINE INITIATED!"
          echo "Producer â†’ Repository Dispatch â†’ Consumer"

  circuit-breaker-demo:
    runs-on: ubuntu-latest
    needs: fibonacci-producer
    steps:
      - name: Circuit Breaker Pattern Demo
        run: |
          echo "ğŸ”„ CIRCUIT BREAKER PATTERN DEMONSTRATION"
          echo "======================================="
          echo ""
          echo "âœ… Producer completed successfully"
          echo "ğŸ”§ Circuit breaker: CLOSED (healthy state)"
          echo "ğŸ¯ This job runs because producer succeeded"
          echo ""
          echo "ğŸ“Š In a real system:"
          echo "  â€¢ Monitor producer success/failure rates"
          echo "  â€¢ Open circuit on repeated failures"  
          echo "  â€¢ Provide fallback responses"
          echo "  â€¢ Auto-recovery with half-open state"
          echo ""
          echo "ğŸš€ Circuit Breaker Demo Complete!"